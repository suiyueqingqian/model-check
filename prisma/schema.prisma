generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Channel {
  id          String       @id @default(cuid())
  name        String       @db.VarChar(100)
  baseUrl     String       @map("base_url") @db.VarChar(500)
  apiKey      String       @map("api_key")
  proxy       String?      @db.VarChar(500)
  enabled       Boolean      @default(true)
  sortOrder     Int          @default(0) @map("sort_order")
  keyMode       String       @default("single") @map("key_mode")
  routeStrategy String       @default("round_robin") @map("route_strategy")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @default(now()) @updatedAt @map("updated_at")
  models        Model[]
  channelKeys   ChannelKey[]

  @@map("channels")
}

model Model {
  id                String      @id @default(cuid())
  channelId         String      @map("channel_id")
  modelName         String      @map("model_name") @db.VarChar(200)
  detectedEndpoints String[]    @default([]) @map("detected_endpoints")
  lastStatus        Boolean?    @map("last_status")
  lastLatency       Int?        @map("last_latency")
  lastCheckedAt     DateTime?   @map("last_checked_at")
  channelKeyId      String?     @map("channel_key_id")
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @default(now()) @updatedAt @map("updated_at")
  checkLogs         CheckLog[]
  channel           Channel     @relation(fields: [channelId], references: [id], onDelete: Cascade)
  channelKey        ChannelKey? @relation(fields: [channelKeyId], references: [id], onDelete: SetNull)

  @@unique([channelId, modelName, channelKeyId])
  @@map("models")
}

model CheckLog {
  id              String       @id @default(cuid())
  modelId         String       @map("model_id")
  endpointType    EndpointType @map("endpoint_type")
  status          CheckStatus
  latency         Int?
  statusCode      Int?         @map("status_code")
  errorMsg        String?      @map("error_msg")
  responseContent String?      @map("response_content")
  createdAt       DateTime     @default(now()) @map("created_at")
  model           Model        @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@index([modelId, createdAt])
  @@index([createdAt])
  @@map("check_logs")
}

model SchedulerConfig {
  id                   String   @id @default("default")
  enabled              Boolean  @default(true)
  cronSchedule         String   @default("0 0,8,12,16,20 * * *") @map("cron_schedule") @db.VarChar(100)
  timezone             String   @default("Asia/Shanghai") @db.VarChar(50)
  channelConcurrency   Int      @default(5) @map("channel_concurrency")
  maxGlobalConcurrency Int      @default(30) @map("max_global_concurrency")
  minDelayMs           Int      @default(3000) @map("min_delay_ms")
  maxDelayMs           Int      @default(5000) @map("max_delay_ms")
  detectAllChannels    Boolean  @default(true) @map("detect_all_channels")
  selectedChannelIds   Json?    @map("selected_channel_ids")
  selectedModelIds     Json?    @map("selected_model_ids")
  updatedAt            DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("scheduler_config")
}

model ProxyKey {
  id                String    @id @default(cuid())
  name              String    @db.VarChar(100)
  key               String    @unique @db.VarChar(100)
  enabled           Boolean   @default(true)
  allowAllModels    Boolean   @default(true) @map("allow_all_models")
  allowedChannelIds Json?     @map("allowed_channel_ids")
  allowedModelIds   Json?     @map("allowed_model_ids")
  lastUsedAt        DateTime? @map("last_used_at")
  usageCount        Int       @default(0) @map("usage_count")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at")

  @@map("proxy_keys")
}

model ChannelKey {
  id        String   @id @default(cuid())
  channelId String   @map("channel_id")
  apiKey    String   @map("api_key")
  name      String?  @db.VarChar(100)
  lastValid     Boolean?  @map("last_valid")
  lastCheckedAt DateTime? @map("last_checked_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")
  channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  models    Model[]

  @@map("channel_keys")
}

model ModelKeyword {
  id        String   @id @default(cuid())
  keyword   String   @db.VarChar(100)
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("model_keywords")
}

enum EndpointType {
  CHAT
  CLAUDE
  GEMINI
  CODEX
  IMAGE
}

enum CheckStatus {
  SUCCESS
  FAIL
}
